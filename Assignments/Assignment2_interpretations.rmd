---
title: "Assignment 2"
subtitle: "Group Assignment 2"
author:
  - "Rishi Ashok Kumar (560527)"
  - "Nicolas Gonzalez (780037)"
  - "Aleksandra Tatko (648925)"
  - "André van der Meij (589994)"
date: "`r format(Sys.Date(), '%B %d, %Y')`"
output:
  pdf_document:
    latex_engine: xelatex
  html_document: default
---


```{r include=FALSE}
# Load required libraries
library(car)      
library(dplyr)
library(tidyverse)
library(knitr)
library(kableExtra)
library(gridExtra)
library(broom)
library(ggpubr)
library(grid)
rm(list=ls())
```

# Question 1

Run a single logistic regression model on the full sample of customers. The logistic regression model should
predict the probability that a customer churns by using the following variables: monthly charges, total
charges, gender, senior citizen status, partner, dependents, tenure, phone service, streaming movies,
contract type, paperless billing, and payment method. Make sure to convert all categorical variables to
factors for appropriate analysis. Note that some variables are already excluded to avoid multicollinearity.
Report only the variance inflation factors (VIFs) for each variable. What do you conclude? (No need to
report the final model output.)

```{r include=FALSE}
stopifnot(file.exists("Telco.csv"))
data <- readr::read_csv("Telco.csv", show_col_types = FALSE)
str(data)
```


```{r include=FALSE}
# Convert relaveant cols to as.factor
# categorical_vars <- c("gender", "SeniorCitizen", "Partner", "Dependents", 
#                      "PhoneService", "StreamingMovies", "Contract", 
#                      "PaperlessBilling", "PaymentMethod", "Churn")
# 
# data[categorical_vars] <- lapply(data[categorical_vars], as.factor)

data$Churn = as.factor(data$Churn)
data[sapply(data, is.character)] <- lapply(data[sapply(data, is.character)], as.factor)


```


```{r include=FALSE}
# Build the logistic regression model
model <- glm(Churn ~ MonthlyCharges + TotalCharges + gender + SeniorCitizen + 
             Partner + Dependents + tenure + PhoneService + StreamingMovies + 
             Contract + PaperlessBilling + PaymentMethod,
             data = data,
             family = "binomial")

summary(model)

# Calculate VIF values
vif_values <- vif(model)

vif_values

# Calcular VIFs
v <- vif(model)

# Detectar si es matriz o vector y armar tabla
if (is.matrix(v)) {
  vif_table <- data.frame(
    Variable = rownames(v),
    VIF = round(v[, "GVIF^(1/(2*Df))"], 2),
    row.names = NULL
  )
} else {
  vif_table <- data.frame(
    Variable = names(v),
    VIF = round(as.numeric(v), 2),
    row.names = NULL
  )
}

```

```{r echo=FALSE}
kable(vif_table, caption = "VIF Values for each variable")
```


Most predictors show a GVIF value below 2, indicating that multicollinearity is not a concern for the majority of the variables. However, three predictors—**MonthlyCharges**, **TotalCharges**, and **tenure**—exhibit GVIF values above 2. This outcome is expected, as these variables are inherently related:  

$$
\text{TotalCharges} \approx \text{MonthlyCharges} \times \text{tenure}
$$

Among them, **TotalCharges** shows the highest degree of multicollinearity. Keeping it alongside **tenure** may reduce the clarity of the model due to overlapping effects. To enhance interpretability, we will exclude **TotalCharges** from the final specification.


# Quesiton 2
Exclude total charges from the model in Question 1 and re-run the logistic regression. Present the final
model output. Select three significant variables and interpret their coefficients (i.e., sign, significance, exact relationship between independent and dependent variables).

```{r include=FALSE}
model_2 <-  glm(Churn ~ MonthlyCharges + gender + SeniorCitizen + 
             Partner + Dependents + tenure + PhoneService + StreamingMovies + 
             Contract + PaperlessBilling + PaymentMethod,
             data = data,
             family = "binomial")

summary(model_2)
```

```{r echo=FALSE}
tidy_model <- tidy(model_2) |> 
  dplyr::mutate(across(where(is.numeric), ~round(., 3))) |> 
  dplyr::rename(
    Term = term,
    Estimate = estimate,
    `Std. Error` = std.error,
    `z value` = statistic,
    `p value` = p.value
  )

kable(tidy_model, caption = "Results from the Logistic Model")
```

Interpretation: 

1. PhoneServiceYes- Customers with phone service have 57% (exp(-0.8447) ≈ 0.43) lower odds of churning compared to those without phone service, holding all other factors constant.

2. Customers on a two-year contract have 82% (exp(-1.6995) ≈ 0.18) lower odds of churning compared to those on a month-to-month contract, ceteris paribus. This suggest that customers with long- term costracts have higher probability of staying in the company.

3. PaymentMethodElectronic check- Customers who pay by electronic check have 49% (exp(0.3986) ≈ 1.49) higher odds of churning compared to those paying by automatic bank transfer, ceteris paribus. This suggest that customers with electronic check as a payment method are in a high-risk group for churn.


# Question 3

Provide two actionable recommendations in light of the model results of Question 2 (i.e., the one excluding
total charges). Provide brief justification for each recommendation.

1. Promote long-term contracts with added benefits.
Since customers on two-year contracts have 82% lower odds of churning compared to month-to-month customers, the company should encourage longer contracts. 
This can be done by offering special discounts, loyalty perks, or bundled services (e.g. internet + streaming) to incentivize signing longer contract. Strengthening these offers will help lock in customers and reduce churn risk.

2. Improve retention strategies for high-risk payment methods.
Customers paying by electronic check have 49% higher odds of churning compared to those using automatic bank transfers. The company should target this group with retention campaigns, such as promoting automatic payment options, offering small discounts for switching payment methods, or providing reminders and support for electronic check users. 
Addressing this high-risk segment directly can reduce churn.


# Question 4
Use the model of Question 2 (i.e., the one excluding total charges). Generate and provide two lists: one
with the 10 customers having the highest predicted churn probabilities and another with the 10 customers
having the lowest predicted churn probabilities. Each list should include the customer ID, the predicted
churn probability, and the actual churn outcome. Present these results in a well-organized table.

```{r include=FALSE}
# We add the predicted variable to the data set. 

data <- data %>% 
  mutate(Prediction = predict(model_2, type = 'response')) %>% 
  rename(ID = customerID)

colnames(data)

top10 <- data %>% 
  dplyr :: select(ID, Prediction, Churn) %>% 
  arrange(desc(Prediction)) %>% 
  head(10)


bottom10 <- data %>% 
  dplyr ::select(ID, Prediction, Churn) %>% 
  arrange(Prediction) %>% 
  head(10)

fmt_num <- function(df) df %>% mutate(across(where(is.numeric), ~round(., 3)))
top10_fmt    <- fmt_num(top10)
bottom10_fmt <- fmt_num(bottom10)

# 2) Tema minimal sin colores fuertes
plain_theme <- ttheme_minimal(
  core = list(
    fg_params = list(fontsize = 10),       # tamaño de fuente celdas
    bg_params = list(fill = NA)            # sin colores de fondo
  ),
  colhead = list(
    fg_params = list(fontface = "bold", fontsize = 10), # encabezados en negrita
    bg_params = list(fill = NA)                         # sin fondo en encabezado
  )
)

# Create a table for each. 
tg1 <- tableGrob(top10_fmt, rows = NULL, theme = plain_theme)
tg1 <- arrangeGrob(tg1, top = textGrob("Top 10",
                                       gp = gpar(fontface = "bold", fontsize = 12),
                                       vjust = 5))

tg2 <- tableGrob(bottom10_fmt, rows = NULL, theme = plain_theme)
tg2 <- arrangeGrob(tg2, top = textGrob("Bottom 10 ",
                                       gp = gpar(fontface = "bold", fontsize = 12),
                                       vjust = 5))

grid.arrange(
  tg1, tg2,
  ncol = 2,
  top = textGrob("Comparison between Top and Bottom.",
                 gp = gpar(fontface = "bold", fontsize = 14),
                 vjust = 4)
)
```


```{r echo=FALSE}
grid.arrange(
  tg1, tg2,
  ncol = 2,
  top = textGrob("Comparison between Top and Bottom.",
                 gp = gpar(fontface = "bold", fontsize = 14),
                 vjust = 4)
)

```





